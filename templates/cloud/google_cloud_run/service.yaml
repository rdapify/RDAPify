apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: rdapify-api
  labels:
    app: rdapify
    version: v0.1.0-alpha.4
  annotations:
    run.googleapis.com/ingress: all
    run.googleapis.com/ingress-status: all
spec:
  template:
    metadata:
      annotations:
        # Autoscaling configuration
        autoscaling.knative.dev/minScale: '1'
        autoscaling.knative.dev/maxScale: '100'
        autoscaling.knative.dev/target: '80'
        
        # CPU throttling
        run.googleapis.com/cpu-throttling: 'false'
        
        # Startup probe
        run.googleapis.com/startup-cpu-boost: 'true'
        
        # VPC connector (optional)
        # run.googleapis.com/vpc-access-connector: projects/PROJECT_ID/locations/REGION/connectors/CONNECTOR_NAME
        # run.googleapis.com/vpc-access-egress: private-ranges-only
    spec:
      # Service account for Cloud Run
      serviceAccountName: rdapify-service-account
      
      # Timeout for requests (max 3600s for Cloud Run)
      timeoutSeconds: 300
      
      containers:
      - name: rdapify
        # Replace with your actual image
        image: gcr.io/PROJECT_ID/rdapify:latest
        
        ports:
        - name: http1
          containerPort: 8080
        
        # Resource limits
        resources:
          limits:
            cpu: '2'
            memory: 1Gi
          requests:
            cpu: '1'
            memory: 512Mi
        
        # Environment variables
        env:
        - name: NODE_ENV
          value: production
        
        - name: PORT
          value: '8080'
        
        # Cache configuration
        - name: CACHE_STRATEGY
          value: memory
        
        - name: CACHE_TTL
          value: '3600'
        
        - name: CACHE_MAX_SIZE
          value: '1000'
        
        # Privacy settings
        - name: REDACT_PII
          value: 'true'
        
        # Retry configuration
        - name: MAX_RETRY_ATTEMPTS
          value: '3'
        
        # Timeout configuration
        - name: REQUEST_TIMEOUT
          value: '10000'
        
        # Security settings
        - name: SSRF_PROTECTION_ENABLED
          value: 'true'
        
        # Logging
        - name: LOG_LEVEL
          value: info
        
        # Startup probe
        startupProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 0
          periodSeconds: 1
          timeoutSeconds: 1
          failureThreshold: 30
        
        # Liveness probe
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 3
          failureThreshold: 3
  
  traffic:
  - percent: 100
    latestRevision: true
